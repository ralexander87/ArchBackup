# Backup Scripts

Portable backup/restore scripts for Linux systems. Includes Bash and Python variants for MAIN, DOTS, and services (GRUB, SMB, SSH). Designed for removable media under `/run/media/$USER` or `/media/$USER` and timestamped backups.

## Highlights
- Paired `.sh` and `.py` scripts for each area
- rsync-based backups with metadata preservation
- Optional compressed archives (pigz)
- Timestamped, self-contained restore folders
- Flags for non-interactive runs

## Requirements
- Linux with `rsync`
- Python `>=3.12` for `.py` scripts
- Optional: `pigz` for compression
- Optional (service scripts): `sudo`, `systemctl`, `testparm`, `sshd`, `pdbedit`

## Quick Start
```bash
./MAIN/backup-main.sh
./MAIN/restore-main.sh --confirm
```

## Safety Notes
- Restore scripts use `rsync --delete-delay` and can delete files not present in the backup.
- Service restores modify system files and require sudo.

## Overview
This repository contains a set of Bash and Python scripts to back up and restore:
- **MAIN** data (user and system files)
- **DOTS** (dotfiles and app configuration)
- **GRUB** (bootloader config and theme assets)
- **SMB** (samba config + service setup + fstab entries)

Each area has paired shell (`.sh`) and Python (`.py`) scripts. The scripts are designed to:
- Preserve ownership, permissions, and metadata (rsync with archive + ACL/Xattr).
- Use external mounted devices under `/run/media/$USER` or `/media/$USER`.
- Create timestamped backup folders for each run.
- Optionally create compressed archives (pigz).
- Provide a short "homepage" prompt with flags.
- Support automation flags (`--no-banner`, `--yes`, etc.).

All backups are written into a folder on the selected external destination:
- MAIN: `.../MAIN/BKP-<timestamp>/`
- DOTS: `.../DOTS/DOTS-<timestamp>/`
- GRUB: `.../SERV/GRUB/GRUB-<timestamp>/`
- SMB: `.../SERV/SMB/SMB-<timestamp>/`

Timestamp format used across the project:
```
date +%j-%d-%m-%H-%M-%S
```

## Directory Layout
```
BACKUP/
  MAIN/
    backup-main.sh
    backup-main.py
    restore-main.sh
    restore-main.py
  DOTS/
    backup-dots.sh
    backup-dots.py
    restore-dots.sh
    restore-dots.py
  SERV/
    GRUB/
      backup-grub.sh
      backup-grub.py
      restore-grub.sh
      restore-grub.py
    SMB/
      backup-smb.sh
      backup-smb.py
      restore-smb.sh
      restore-smb.py
    SSH/
      backup-ssh.sh
      backup-ssh.py
      restore-ssh.sh
      restore-ssh.py
  scripts/
    common.sh
  common.py
```

## Shared Behavior
### Destination Selection
All backup scripts:
- Discover external mounts under `/run/media/$USER` and `/media/$USER`.
- List them with numeric choices.
- Auto-select if only one is found; otherwise prompt for selection and confirmation.
- Validate mount safety (ignore tmpfs/overlay/squashfs/etc.).

### Metadata Preservation
Backups and restores use rsync with metadata preservation:
- Shell: `rsync -aHAX --numeric-ids --sparse`
- Python: same options; also logs rsync stats.

### Logging
- MAIN backups write logs inside the backup folder by default.
- DOTS backups can write logs to `--log-dir`.
- You can redirect logs to a separate location with `--log-dir`.
- `.log` files are ignored by git.

### Manifests
Backups write a manifest file:
- MAIN: `sources.txt` and `excludes.txt`
- DOTS: `sources.txt`

## MAIN Backups
### What is backed up
From `/home/$USER/`:
```
Documents Downloads Pictures Obsidian Working Shared VM Code Videos
.config .var .ssh .icons .themes .mydotfiles .local .oh-my-zsh
```

Special handling:
- `VM`: excludes `VM/ISO`
- `Downloads`: excludes `*.iso`
- `.ssh`: excludes `agent/`

Global excludes (always skipped):
```
.cache/ .var/app/ .subversion/ .mozilla/ .local/share/fonts/
.local/share/fonts/NerdFonts/ .vscode-oss/ Trash/ .config/*/Cache/
.config/*/cache/ .config/*/Code Cache/ .config/*/GPUCache/
.config/*/CachedData/ .config/*/CacheStorage/ .config/*/Service Worker/
.config/*/IndexedDB/ .config/*/Local Storage/ .config/rambox/ .rustup/
```

Restore scripts are copied into each backup:
```
MAIN/restore-main.sh
MAIN/restore-main.py
```

### Compression
If enabled, creates:
```
MAIN/BKP-<timestamp>/BKP-<timestamp>.tar.gz
```

## MAIN Restore
Restores from the timestamped folder where the restore script resides.

Restored items:
```
Documents Downloads Pictures Obsidian Working Shared VM Code Videos
.icons .themes .local/share/icons .ssh
```

Post-restore actions:
- `.ssh` permissions enforced:
  - directory `700`
  - `*.pub` files `644`
  - all other files `600`
- Hyprland config edit:
  - `autogenerated = 1` → `# autogenerated = 1`
- SDDM config update (sudo):
  - `/usr/lib/sddm/sddm.conf.d/default.conf`
  - `User=<current user>`
- Optional: run `/run/media/$USER/BIG/fonts/install.sh`
- Optional: `flatpak install flathub com.ml4w.dotfilesinstaller`

## DOTS Backups
### What is backed up
- Dotfiles config root:
  ```
  /home/$USER/.mydotfiles/com.ml4w.dotfiles.stable/.config
  ```
- Hyprland settings:
  ```
  /home/$USER/.config/com.ml4w.hyprlandsettings/hyprctl.json
  ```
- Restore scripts:
  ```
  DOTS/restore-dots.sh
  DOTS/restore-dots.py
  ```

### Compression
If enabled, creates:
```
DOTS/DOTS-<timestamp>/DOTS-<timestamp>.tar.gz
```

## DOTS Restore
Restores only specific items from the timestamp folder:

General:
```
fastfetch cava matugen kitty rofi zshrc
```

Waybar:
```
waybar/themes/ralex
```

GTK / Qt:
```
gtk-3.0/settings.ini
gtk-3.0/bookmarks
gtk-4.0/settings.ini
qt6ct/qt6ct.conf
```

Hypr:
```
hypr/hyprlock.conf
hypr/hypridle.conf
hypr/logo-2.png
hypr/scripts/uptime.sh
hypr/conf/animation.conf
hypr/conf/cursor.conf
hypr/conf/decoration.conf
hypr/conf/environment.conf
hypr/conf/keybinding.conf
hypr/conf/layout.conf
hypr/conf/monitor.conf
hypr/conf/window.conf
hypr/conf/keybindings/lateralus.conf
```

ML4W settings:
```
ml4w/settings/editor.sh
ml4w/settings/filemanager
ml4w/settings/filemanager.sh
ml4w/settings/rofi-border-radius.rasi
ml4w/settings/rofi-border.rasi
ml4w/settings/rofi-font.rasi
ml4w/settings/rofi_bordersize.sh
ml4w/settings/screenshot-editor
ml4w/settings/screenshot-folder
ml4w/settings/terminal.sh
ml4w/settings/wallpaper-folder
ml4w/settings/waybar-theme.sh
```

Wlogout:
```
wlogout/themes/glass/style.css
```

Hyprland settings:
```
hyprctl.json -> /home/$USER/.config/com.ml4w.hyprlandsettings/
```

Additional restore steps:
- Creates symlink:
  - `~/.config/cava` → `~/.mydotfiles/.../.config/cava`
- Creates symlink:
  - `~/.mydotfiles/.../.config/ml4w/wallpapers` → `~/Pictures/wallpapers`
- Writes to Hyprland environment config if missing:
  ```
  env = AQ_DRM_DEVICES,/dev/dri/card1:/dev/dri/card2
  ```
- Downloads Dracula qBittorrent theme if needed:
  ```
  ~/.config/qBittorrent/dracula.qbtheme
  ```
- Updates qBittorrent config:
  ```
  General\CustomUIThemePath=/home/$USER/.config/qBittorrent/dracula.qbtheme
  General\UseCustomUITheme=true
  ```

## GRUB Backups
GRUB backup scripts prompt for sudo and copy:
```
/boot/grub/themes/lateralus
/etc/default/grub
```

Destination:
```
.../SERV/GRUB/
```

## GRUB Restore
Restores from the folder containing the restore script:
- Copies `lateralus` theme into `/boot/grub/themes/`
- Backs up `/etc/default/grub` into the restore folder
- Updates:
  - `GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet splash"`
  - `GRUB_GFXMODE=1440x1080x32`
  - `GRUB_THEME="/boot/grub/themes/lateralus/theme.txt"`
  - `GRUB_TERMINAL_OUTPUT=gfxterm`
  - Comments `GRUB_TERMINAL_INPUT=console`
- Regenerates GRUB config with:
  ```
  sudo grub-mkconfig -o /boot/grub/grub.cfg
  ```

## SMB Backups
SMB backup scripts prompt for sudo and copy:
```
/etc/samba/smb.conf
/etc/fstab
/etc/samba/creds-*
```

Destination:
```
.../SERV/SMB/
```

## SMB Restore
SMB restore scripts:
- Enable and start services:
  - `avahi-daemon`, `nmb`, `smb`, `sshd`, `wsdd`
- Run `sudo modprobe cifs`
- Create `/SMB` folder structure with `750` permissions owned by the local user:
  - `/SMB/euclid`, `/SMB/pneuma`, `/SMB/lateralus`, `/SMB/SCP/HDD-0{1,2,3}`
- Restore `/etc/samba/smb.conf` and `creds-*` files with root ownership:
  - `smb.conf` → `root:root` `644`
  - `creds-*` → `root:root` `600`
- Validate `smb.conf` with `testparm`
- Append required CIFS mount lines to `/etc/fstab` if missing
- Prompt to add a Samba user with `smbpasswd -a`

## SSH Backups
SSH backup scripts copy:
```
/home/$USER/.ssh (excludes .ssh/agent)
/etc/ssh/sshd_config
```

Destination:
```
.../SERV/SSH/
```

Additional behavior:
- Copies `restore-ssh.sh` and `restore-ssh.py` into each backup
- Optional rotation: `--keep <count>` (default 5)

## SSH Restore
SSH restore scripts:
- Ensure `sshd.service` is installed, enabled, and started
- Restore `/home/$USER/.ssh` and enforce permissions + ownership
- Restore `/etc/ssh/sshd_config` with root ownership and `600` perms
- Validate config with `sshd -t`
- Optional: verify key fingerprints with `ssh-keygen -lf`
- Restart `sshd.service` unless `--no-restart` is set

## Flags
### Backup scripts
- `--no-compress`: skip compression prompt
- `--log-dir <dir>`: write logs to a custom directory
- `--manifest-only`: write manifests and exit
- `--no-banner`: skip the startup banner prompt
- `--yes`: auto-confirm prompts

### Restore scripts
- `--confirm`: prompt before destructive restore
- `--yes`: auto-confirm destructive prompt
- `--no-banner`: skip the startup banner prompt

## Usage Examples
### MAIN backup
```bash
./MAIN/backup-main.sh
./MAIN/backup-main.sh --no-compress --log-dir /home/$USER/backup-logs
./MAIN/backup-main.sh --manifest-only --no-banner
```

### MAIN restore
```bash
./MAIN/restore-main.sh --confirm
./MAIN/restore-main.sh --confirm --no-banner
./MAIN/restore-main.sh --confirm --yes
```

### DOTS backup
```bash
./DOTS/backup-dots.sh
./DOTS/backup-dots.sh --no-compress --log-dir /home/$USER/backup-logs
./DOTS/backup-dots.sh --manifest-only --no-banner
```

### DOTS restore
```bash
./DOTS/restore-dots.sh --confirm
./DOTS/restore-dots.sh --confirm --no-banner
./DOTS/restore-dots.sh --confirm --yes
```

### GRUB backup
```bash
./SERV/GRUB/backup-grub.sh
./SERV/GRUB/backup-grub.py
```

### GRUB restore
```bash
./SERV/GRUB/restore-grub.sh --confirm
./SERV/GRUB/restore-grub.py --confirm
```

### SMB backup
```bash
./SERV/SMB/backup-smb.sh
./SERV/SMB/backup-smb.py
```

### SMB restore
```bash
./SERV/SMB/restore-smb.sh --confirm
./SERV/SMB/restore-smb.py --confirm
```

### SSH backup
```bash
./SERV/SSH/backup-ssh.sh
./SERV/SSH/backup-ssh.py
./SERV/SSH/backup-ssh.sh --keep 10 --no-compress
```

### SSH restore
```bash
./SERV/SSH/restore-ssh.sh --confirm
./SERV/SSH/restore-ssh.py --confirm --no-restart
```

## Notes
- Restore scripts use `rsync --delete-delay`. This can remove files not present in backups.
- `--confirm` is recommended for interactive restores.
